<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lock Quests - Escape Room Reviews</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Source+Sans+3:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        /* Filter & Search Styles */
        .filter-bar {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .search-row {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .search-box {
            flex: 1;
            position: relative;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 45px 12px 15px;
            border: 2px solid #eee;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: var(--lockquest-purple);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .search-box input::placeholder {
            color: #999;
        }
        
        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--lockquest-gray);
            font-size: 1.2em;
        }
        
        .filters-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .filter-group label {
            font-weight: 600;
            color: var(--lockquest-dark);
        }
        
        .filter-group select {
            padding: 10px 15px;
            border: 2px solid #eee;
            border-radius: 8px;
            font-size: 1em;
            background: white;
            color: var(--lockquest-dark);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .filter-group select:hover {
            border-color: var(--lockquest-purple);
        }
        
        .filter-group select:focus {
            outline: none;
            border-color: var(--lockquest-purple);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .clear-filters {
            margin-left: auto;
            background: var(--lockquest-purple);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .clear-filters:hover {
            background: var(--lockquest-dark-purple);
        }
        
        .results-info {
            color: var(--lockquest-gray);
            font-size: 0.95em;
            margin-bottom: 20px;
        }
        
        .active-filter-badge {
            background: var(--lockquest-purple);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin: 0 5px 10px 0;
        }
        
        .active-filter-badge button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.2em;
            padding: 0;
            line-height: 1;
        }
    </style>
</head>
<body>
    <header class="site-header">
        <div class="header-content">
            <a href="index.html" class="logo">üîê LOCK QUESTS</a>
            <nav class="nav">
                <a href="index.html">Home</a>
                <a href="#about">About Us</a>
                <a href="#escapes">Our Escapes</a>
                <a href="#top">Top Rooms</a>
            </nav>
        </div>
    </header>
    
    <div class="container">
        <div class="setup-box" id="setupBox">
            <h2>üöÄ Setup Required</h2>
            <p style="font-size: 1.1em; margin-bottom: 20px;">
                Add your Google Sheet ID and API Key to <strong>config.js</strong> to load your rooms!
            </p>
            
            <div class="setup-steps">
                <h3>Quick Setup:</h3>
                <ol>
                    <li>Open <code>config.js</code> in a text editor</li>
                    <li>Replace <code>YOUR_SHEET_ID</code> with your Google Sheet ID</li>
                    <li>Replace <code>YOUR_API_KEY</code> with your Google API Key</li>
                    <li>Save and reload this page</li>
                </ol>
            </div>
        </div>
        
        <div id="roomsContainer" style="display: none;">
            <h2 style="font-family: 'Bebas Neue', sans-serif; font-size: 2.5em; margin-bottom: 20px; letter-spacing: 1px;">
                Our Escape Room Adventures
            </h2>
            
            <!-- Active Filters Display -->
            <div id="activeFilters" style="margin-bottom: 15px;"></div>
            
            <!-- Filter Bar -->
            <div class="filter-bar">
                <!-- Search Row -->
                <div class="search-row">
                    <div class="search-box">
                        <input type="text" 
                               id="searchBox" 
                               placeholder="Search by room name, company, or location..."
                               autocomplete="off">
                        <span class="search-icon">üîç</span>
                    </div>
                </div>
                
                <!-- Filters Row -->
                <div class="filters-row">
                    <div class="filter-group">
                        <label for="stateFilter">State:</label>
                        <select id="stateFilter">
                            <option value="">All States</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="ratingFilter">Rating:</label>
                        <select id="ratingFilter">
                            <option value="">All Ratings</option>
                            <option value="5">5 Stars</option>
                            <option value="4.5">4.5+ Stars</option>
                            <option value="4">4+ Stars</option>
                            <option value="3.5">3.5+ Stars</option>
                            <option value="3">3+ Stars</option>
                            <option value="2">2+ Stars</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="sortFilter">Sort:</label>
                        <select id="sortFilter">
                            <option value="date-desc">Newest First</option>
                            <option value="date-asc">Oldest First</option>
                            <option value="rating-desc">Highest Rated</option>
                            <option value="rating-asc">Lowest Rated</option>
                            <option value="name-asc">Name A-Z</option>
                            <option value="name-desc">Name Z-A</option>
                        </select>
                    </div>
                    
                    <button class="clear-filters" id="clearFilters">Clear All</button>
                </div>
            </div>
            
            <!-- Results Info -->
            <div class="results-info">
                Showing <strong id="filteredCount">0</strong> of <strong id="totalCount">0</strong> rooms
            </div>
            
            <!-- Room Grid -->
            <div class="grid" id="roomsGrid"></div>
        </div>
        
        <div id="loadingContainer" style="display: none;">
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>Loading rooms from Google Sheets...</p>
            </div>
        </div>
    </div>
    
    <script src="config.js"></script>
    <script>
        // Global state
        let allRooms = [];
        let filteredRooms = [];
        let searchTimeout;
        
        // Get URL parameters
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                search: params.get('search') || '',
                state: params.get('state') || '',
                company: params.get('company') || '',
                rating: params.get('rating') || '',
                sort: params.get('sort') || 'date-desc'
            };
        }
        
        // Update URL without reload
        function updateUrl(params) {
            const url = new URL(window.location);
            Object.keys(params).forEach(key => {
                if (params[key]) {
                    url.searchParams.set(key, params[key]);
                } else {
                    url.searchParams.delete(key);
                }
            });
            window.history.pushState({}, '', url);
        }
        
        // Initialize
        (function() {
            const config = window.LOCKQUESTS_CONFIG;
            
            if (!config || config.SHEET_ID === 'YOUR_SHEET_ID' || config.API_KEY === 'YOUR_API_KEY') {
                console.log('Please configure your Google Sheet ID and API Key in config.js');
                return;
            }
            
            document.getElementById('setupBox').style.display = 'none';
            document.getElementById('loadingContainer').style.display = 'block';
            
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${config.SHEET_ID}/values/${config.SHEET_RANGE}?key=${config.API_KEY}`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.values) {
                        loadRooms(data.values);
                    } else {
                        showError('No data found in sheet');
                    }
                })
                .catch(error => {
                    console.error('Error loading data:', error);
                    showError('Error loading data. Check console for details.');
                });
        })();
        
        function slugify(text) {
            return text.toLowerCase()
                .replace(/[^\w\s-]/g, '')
                .replace(/[\s_-]+/g, '-')
                .replace(/^-+|-+$/g, '');
        }
        
        function loadRooms(sheetData) {
            const headers = sheetData[0];
            const rows = sheetData.slice(1);
            
            const colIndices = {
                roomName: headers.indexOf('Room Name'),
                company: headers.indexOf('Company'),
                location: headers.indexOf('Location'),
                state: headers.indexOf('State/Region'),
                date: headers.indexOf('Date'),
                timeLeft: headers.indexOf('Time Left'),
                avgRating: headers.indexOf('Average Rating'),
                togetherNum: headers.indexOf('Together Unique #')
            };
            
            allRooms = rows
                .filter(row => row[colIndices.togetherNum])
                .map(row => ({
                    roomName: row[colIndices.roomName] || '',
                    company: row[colIndices.company] || '',
                    location: row[colIndices.location] || '',
                    state: row[colIndices.state] || '',
                    date: row[colIndices.date] || '',
                    timeLeft: row[colIndices.timeLeft] || '',
                    avgRating: parseFloat(row[colIndices.avgRating]) || 0,
                    togetherNum: parseInt(row[colIndices.togetherNum]) || 0
                }));
            
            // Populate state filter
            const states = [...new Set(allRooms.map(r => r.state))].sort();
            const stateFilter = document.getElementById('stateFilter');
            states.forEach(state => {
                const option = document.createElement('option');
                option.value = state;
                option.textContent = state;
                stateFilter.appendChild(option);
            });
            
            // Apply URL parameters
            const urlParams = getUrlParams();
            document.getElementById('searchBox').value = urlParams.search;
            document.getElementById('stateFilter').value = urlParams.state;
            document.getElementById('ratingFilter').value = urlParams.rating;
            document.getElementById('sortFilter').value = urlParams.sort;
            
            // Set up event listeners
            document.getElementById('searchBox').addEventListener('input', onSearchChange);
            document.getElementById('stateFilter').addEventListener('change', onFilterChange);
            document.getElementById('ratingFilter').addEventListener('change', onFilterChange);
            document.getElementById('sortFilter').addEventListener('change', onFilterChange);
            document.getElementById('clearFilters').addEventListener('click', clearFilters);
            
            // Initial display
            applyFilters();
            
            document.getElementById('loadingContainer').style.display = 'none';
            document.getElementById('roomsContainer').style.display = 'block';
        }
        
        function onSearchChange() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                onFilterChange();
            }, 300); // Debounce search
        }
        
        function onFilterChange() {
            const params = {
                search: document.getElementById('searchBox').value,
                state: document.getElementById('stateFilter').value,
                rating: document.getElementById('ratingFilter').value,
                sort: document.getElementById('sortFilter').value
            };
            updateUrl(params);
            applyFilters();
        }
        
        function applyFilters() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            const stateFilter = document.getElementById('stateFilter').value;
            const ratingFilter = parseFloat(document.getElementById('ratingFilter').value) || 0;
            const sortFilter = document.getElementById('sortFilter').value;
            
            // Get company from URL if present (from tag clicks)
            const urlParams = getUrlParams();
            const companyFilter = urlParams.company || '';
            
            // Filter
            filteredRooms = allRooms.filter(room => {
                const searchMatch = !searchTerm || 
                    room.roomName.toLowerCase().includes(searchTerm) ||
                    room.company.toLowerCase().includes(searchTerm) ||
                    room.location.toLowerCase().includes(searchTerm);
                const stateMatch = !stateFilter || room.state === stateFilter;
                const companyMatch = !companyFilter || room.company === companyFilter;
                const ratingMatch = room.avgRating >= ratingFilter;
                return searchMatch && stateMatch && companyMatch && ratingMatch;
            });
            
            // Sort
            filteredRooms.sort((a, b) => {
                switch(sortFilter) {
                    case 'date-desc':
                        return b.togetherNum - a.togetherNum;
                    case 'date-asc':
                        return a.togetherNum - b.togetherNum;
                    case 'rating-desc':
                        return b.avgRating - a.avgRating;
                    case 'rating-asc':
                        return a.avgRating - b.avgRating;
                    case 'name-asc':
                        return a.roomName.localeCompare(b.roomName);
                    case 'name-desc':
                        return b.roomName.localeCompare(a.roomName);
                    default:
                        return b.togetherNum - a.togetherNum;
                }
            });
            
            displayActiveFilters(companyFilter);
            displayRooms();
        }
        
        function displayActiveFilters(companyFilter) {
            const container = document.getElementById('activeFilters');
            const search = document.getElementById('searchBox').value;
            const state = document.getElementById('stateFilter').value;
            const rating = document.getElementById('ratingFilter').value;
            
            let html = '';
            
            if (search) {
                html += `<span class="active-filter-badge">Search: "${search}" <button onclick="removeFilter('search')">√ó</button></span>`;
            }
            if (state) {
                html += `<span class="active-filter-badge">State: ${state} <button onclick="removeFilter('state')">√ó</button></span>`;
            }
            if (companyFilter) {
                html += `<span class="active-filter-badge">Company: ${companyFilter} <button onclick="removeFilter('company')">√ó</button></span>`;
            }
            if (rating) {
                html += `<span class="active-filter-badge">Rating: ${rating}+ Stars <button onclick="removeFilter('rating')">√ó</button></span>`;
            }
            
            container.innerHTML = html;
        }
        
        window.removeFilter = function(type) {
            if (type === 'search') document.getElementById('searchBox').value = '';
            if (type === 'state') document.getElementById('stateFilter').value = '';
            if (type === 'rating') document.getElementById('ratingFilter').value = '';
            if (type === 'company') {
                const url = new URL(window.location);
                url.searchParams.delete('company');
                window.history.pushState({}, '', url);
            }
            onFilterChange();
        };
        
        function clearFilters() {
            document.getElementById('searchBox').value = '';
            document.getElementById('stateFilter').value = '';
            document.getElementById('ratingFilter').value = '';
            document.getElementById('sortFilter').value = 'date-desc';
            updateUrl({});
            applyFilters();
        }
        
        function displayRooms() {
            document.getElementById('totalCount').textContent = allRooms.length;
            document.getElementById('filteredCount').textContent = filteredRooms.length;
            
            const html = filteredRooms.map(room => {
                const numPadded = String(room.togetherNum).padStart(4, '0');
                const slug = slugify(room.roomName);
                
                return `
                    <a href="room.html?id=${room.togetherNum}" class="room-card">
                        <div class="room-image">
                            <img src="https://matthewgleavitt.github.io/lockquests/photos/${numPadded}-${slug}.jpg" 
                                 alt="${room.roomName}"
                                 onerror="this.src='https://matthewgleavitt.github.io/lockquests/photos/${numPadded}-${slug}.JPG'; this.onerror=function(){this.style.display='none'; this.parentElement.innerHTML='<div style=\\'position: relative; z-index: 1; text-align: center;\\'><div style=\\'font-family: Bebas Neue, sans-serif; font-size: 2em; opacity: 0.7;\\'>#${numPadded}</div><div style=\\'font-size: 0.9em; margin-top: 10px;\\'>üì∑ Photo: ${numPadded}-${slug}.jpg</div></div>';};"
                                 style="width: 100%; height: 100%; object-fit: cover;">
                        </div>
                        <div class="room-content">
                            <div class="room-title">${room.roomName}</div>
                            <div class="room-company">${room.company}</div>
                            <div class="room-location">${room.location}, ${room.state}</div>
                            <div class="room-rating">‚òÖ ${room.avgRating.toFixed(1)} / 5.0</div>
                            <div class="room-meta">
                                <span>üìÖ ${formatDate(room.date)}</span>
                                <span>‚è±Ô∏è ${room.timeLeft}</span>
                            </div>
                        </div>
                    </a>
                `;
            }).join('');
            
            document.getElementById('roomsGrid').innerHTML = html || '<p style="grid-column: 1/-1; text-align: center; padding: 60px 20px; color: #999;">No rooms found matching your search.</p>';
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }
        
        function showError(message) {
            document.getElementById('loadingContainer').innerHTML = 
                `<div class="loading"><p>${message}</p></div>`;
        }
        
        window.slugify = slugify;
    </script>
</body>
</html>
